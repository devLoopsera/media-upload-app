<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Media</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }
        .container {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 30px;
        }
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        .btn {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: opacity 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }
        .btn-submit {
            background: #28a745;
            margin-top: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
        .loading {
            background: #e8f4fd;
            color: #0088cc;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #fff3cd;
            color: #856404;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preview-container {
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .preview-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            background: #f5f5f5;
        }
        .preview-item img,
        .preview-item video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .remove-btn:active {
            transform: scale(0.95);
        }
        input[type="file"] {
            display: none;
        }
        .media-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            margin: 10px 0;
            font-weight: 500;
        }
        .file-limit {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">üì∏ Upload Media</h1>
        <p class="subtitle" id="subtitle">Capture or upload photos and videos</p>
        
        <div class="action-buttons">
            <button class="btn" onclick="capturePhoto()">
                <span id="btnTakePhoto">üì∑ Take Photo</span>
            </button>
            <button class="btn" onclick="captureVideo()">
                <span id="btnRecordVideo">üé• Record Video</span>
            </button>
            <button class="btn btn-secondary" onclick="selectFromGallery()">
                <span id="btnChooseGallery">üñºÔ∏è Choose from Gallery</span>
            </button>
        </div>

        <div class="media-count" id="mediaCount"></div>
        <div class="file-limit" id="fileLimit">Maximum 10 files, 50MB each</div>
        
        <div class="preview-container" id="previewContainer"></div>
        
        <div id="status"></div>
        
        <button class="btn btn-submit" onclick="submitAll()" id="submitBtn" style="display: none;">
            <span id="btnSubmit">‚úÖ Submit All Files</span>
        </button>

        <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handleFileSelect(event)">
        <input type="file" id="videoInput" accept="video/*" capture="environment" onchange="handleFileSelect(event)">
        <input type="file" id="galleryInput" accept="image/*,video/*" multiple onchange="handleFileSelect(event)">
    </div>

    <script>
        // Initialize Telegram Web App
        let tg = window.Telegram.WebApp;
        tg.expand();
        
        // **REPLACE THIS WITH YOUR N8N WEBHOOK URL**
        const WEBHOOK_URL = 'https://n8n.la-renting.com/webhook/get-media';
        
        // Get user info from Telegram
        const telegramUser = tg.initDataUnsafe.user;
        
        // Language translations
        const translations = {
            en: {
                title: "üì∏ Upload Media",
                subtitle: "Capture or upload photos and videos",
                btnTakePhoto: "üì∑ Take Photo",
                btnRecordVideo: "üé• Record Video",
                btnChooseGallery: "üñºÔ∏è Choose from Gallery",
                btnSubmit: "‚úÖ Submit All Files",
                fileLimit: "Maximum 10 files, 50MB each",
                filesSelected: "file(s) selected",
                processingFiles: "Processing files...",
                filesAdded: "file(s) added successfully!",
                filesSkipped: "file(s) skipped (size limit or max files reached)",
                fileRemoved: "File removed",
                maxFilesReached: "Maximum 10 files allowed",
                fileTooLarge: "is too large (max 50MB)",
                uploadingFiles: "Uploading files...",
                uploadSuccess: "All files uploaded successfully!<br>You can close this window now.",
                uploadFailed: "Failed to upload files. Please try again.",
                addFilesFirst: "Please add at least one photo or video"
            },
            de: {
                title: "üì∏ Medien hochladen",
                subtitle: "Fotos und Videos aufnehmen oder hochladen",
                btnTakePhoto: "üì∑ Foto aufnehmen",
                btnRecordVideo: "üé• Video aufnehmen",
                btnChooseGallery: "üñºÔ∏è Aus Galerie w√§hlen",
                btnSubmit: "‚úÖ Alle Dateien senden",
                fileLimit: "Maximal 10 Dateien, je 50MB",
                filesSelected: "Datei(en) ausgew√§hlt",
                processingFiles: "Dateien werden verarbeitet...",
                filesAdded: "Datei(en) erfolgreich hinzugef√ºgt!",
                filesSkipped: "Datei(en) √ºbersprungen (Gr√∂√üenlimit oder maximale Anzahl erreicht)",
                fileRemoved: "Datei entfernt",
                maxFilesReached: "Maximal 10 Dateien erlaubt",
                fileTooLarge: "ist zu gro√ü (max 50MB)",
                uploadingFiles: "Dateien werden hochgeladen...",
                uploadSuccess: "Alle Dateien erfolgreich hochgeladen!<br>Sie k√∂nnen dieses Fenster jetzt schlie√üen.",
                uploadFailed: "Hochladen fehlgeschlagen. Bitte versuchen Sie es erneut.",
                addFilesFirst: "Bitte f√ºgen Sie mindestens ein Foto oder Video hinzu"
            },
            ru: {
                title: "üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞",
                subtitle: "–°–¥–µ–ª–∞–π—Ç–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ",
                btnTakePhoto: "üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ",
                btnRecordVideo: "üé• –ó–∞–ø–∏—Å–∞—Ç—å –≤–∏–¥–µ–æ",
                btnChooseGallery: "üñºÔ∏è –í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏",
                btnSubmit: "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã",
                fileLimit: "–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª–æ–≤, –ø–æ 50–ú–ë –∫–∞–∂–¥—ã–π",
                filesSelected: "—Ñ–∞–π–ª(–æ–≤) –≤—ã–±—Ä–∞–Ω–æ",
                processingFiles: "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...",
                filesAdded: "—Ñ–∞–π–ª(–æ–≤) —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!",
                filesSkipped: "—Ñ–∞–π–ª(–æ–≤) –ø—Ä–æ–ø—É—â–µ–Ω–æ (–ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)",
                fileRemoved: "–§–∞–π–ª —É–¥–∞–ª–µ–Ω",
                maxFilesReached: "–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ",
                fileTooLarge: "—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 50–ú–ë)",
                uploadingFiles: "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...",
                uploadSuccess: "–í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!<br>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ –æ–∫–Ω–æ.",
                uploadFailed: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                addFilesFirst: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ"
            },
            uk: {
                title: "üì∏ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–µ–¥—ñ–∞",
                subtitle: "–ó—Ä–æ–±—ñ—Ç—å –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ñ–æ—Ç–æ —Ç–∞ –≤—ñ–¥–µ–æ",
                btnTakePhoto: "üì∑ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ",
                btnRecordVideo: "üé• –ó–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–µ–æ",
                btnChooseGallery: "üñºÔ∏è –í–∏–±—Ä–∞—Ç–∏ –∑ –≥–∞–ª–µ—Ä–µ—ó",
                btnSubmit: "‚úÖ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—Å—ñ —Ñ–∞–π–ª–∏",
                fileLimit: "–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª—ñ–≤, –ø–æ 50–ú–ë –∫–æ–∂–µ–Ω",
                filesSelected: "—Ñ–∞–π–ª(—ñ–≤) –≤–∏–±—Ä–∞–Ω–æ",
                processingFiles: "–û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—ñ–≤...",
                filesAdded: "—Ñ–∞–π–ª(—ñ–≤) —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!",
                filesSkipped: "—Ñ–∞–π–ª(—ñ–≤) –ø—Ä–æ–ø—É—â–µ–Ω–æ (–ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ª—ñ–º—ñ—Ç —Ä–æ–∑–º—ñ—Ä—É –∞–±–æ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ)",
                fileRemoved: "–§–∞–π–ª –≤–∏–¥–∞–ª–µ–Ω–æ",
                maxFilesReached: "–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª—ñ–≤ –¥–æ–∑–≤–æ–ª–µ–Ω–æ",
                fileTooLarge: "–∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–∏–π (–º–∞–∫—Å 50–ú–ë)",
                uploadingFiles: "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤...",
                uploadSuccess: "–í—Å—ñ —Ñ–∞–π–ª–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!<br>–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–∫—Ä–∏—Ç–∏ —Ü–µ –≤—ñ–∫–Ω–æ.",
                uploadFailed: "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                addFilesFirst: "–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–Ω–µ —Ñ–æ—Ç–æ –∞–±–æ –≤—ñ–¥–µ–æ"
            },
            ro: {
                title: "üì∏ √éncarcƒÉ media",
                subtitle: "CaptureazƒÉ sau √ÆncarcƒÉ fotografii »ôi videoclipuri",
                btnTakePhoto: "üì∑ FƒÉ fotografie",
                btnRecordVideo: "üé• √énregistreazƒÉ video",
                btnChooseGallery: "üñºÔ∏è Alege din galerie",
                btnSubmit: "‚úÖ Trimite toate fi»ôierele",
                fileLimit: "Maxim 10 fi»ôiere, c√¢te 50MB fiecare",
                filesSelected: "fi»ôier(e) selectat(e)",
                processingFiles: "Se proceseazƒÉ fi»ôierele...",
                filesAdded: "fi»ôier(e) adƒÉugat(e) cu succes!",
                filesSkipped: "fi»ôier(e) omis(e) (limitƒÉ de dimensiune sau numƒÉr maxim atins)",
                fileRemoved: "Fi»ôier eliminat",
                maxFilesReached: "Maxim 10 fi»ôiere permise",
                fileTooLarge: "este prea mare (max 50MB)",
                uploadingFiles: "Se √ÆncarcƒÉ fi»ôierele...",
                uploadSuccess: "Toate fi»ôierele au fost √ÆncƒÉrcate cu succes!<br>Pute»õi √Ænchide aceastƒÉ fereastrƒÉ acum.",
                uploadFailed: "√éncƒÉrcarea a e»ôuat. VƒÉ rugƒÉm sƒÉ √Æncerca»õi din nou.",
                addFilesFirst: "VƒÉ rugƒÉm sƒÉ adƒÉuga»õi cel pu»õin o fotografie sau un videoclip"
            }
        };

        // Get language and job_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const language = urlParams.get('lang') || 'en';
        const jobId = urlParams.get('job_id') || null;
        const t = translations[language] || translations.en;

        // Apply translations on page load
        function applyTranslations() {
            document.getElementById('title').textContent = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('btnTakePhoto').textContent = t.btnTakePhoto;
            document.getElementById('btnRecordVideo').textContent = t.btnRecordVideo;
            document.getElementById('btnChooseGallery').textContent = t.btnChooseGallery;
            document.getElementById('btnSubmit').textContent = t.btnSubmit;
            document.getElementById('fileLimit').textContent = t.fileLimit;
        }

        // Apply translations when page loads
        applyTranslations();
        
        // Store collected data
        let collectedData = {
            job_id: jobId,
            telegram_user_id: telegramUser?.id,
            telegram_username: telegramUser?.username,
            telegram_first_name: telegramUser?.first_name,
            telegram_last_name: telegramUser?.last_name,
            language: language,
            timestamp: new Date().toISOString(),
            media: []
        };

        const MAX_FILES = 10;
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function updateMediaCount() {
            const count = collectedData.media.length;
            const countDiv = document.getElementById('mediaCount');
            
            if (count > 0) {
                countDiv.textContent = `${count} ${t.filesSelected}`;
                document.getElementById('submitBtn').style.display = 'block';
            } else {
                countDiv.textContent = '';
                document.getElementById('submitBtn').style.display = 'none';
            }
        }

        function capturePhoto() {
            if (collectedData.media.length >= MAX_FILES) {
                showStatus(t.maxFilesReached, 'error');
                return;
            }
            document.getElementById('photoInput').click();
        }

        function captureVideo() {
            if (collectedData.media.length >= MAX_FILES) {
                showStatus(t.maxFilesReached, 'error');
                return;
            }
            document.getElementById('videoInput').click();
        }

        function selectFromGallery() {
            if (collectedData.media.length >= MAX_FILES) {
                showStatus(t.maxFilesReached, 'error');
                return;
            }
            document.getElementById('galleryInput').click();
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            showStatus(`<div class="spinner"></div>${t.processingFiles}`, 'loading');

            let filesAdded = 0;
            let filesSkipped = 0;

            for (let file of files) {
                // Check if we've reached max files
                if (collectedData.media.length >= MAX_FILES) {
                    filesSkipped++;
                    continue;
                }

                // Check file size
                if (file.size > MAX_FILE_SIZE) {
                    showStatus(`${file.name} ${t.fileTooLarge}`, 'error');
                    filesSkipped++;
                    continue;
                }

                try {
                    // Convert to base64
                    const base64 = await fileToBase64(file);
                    
                    collectedData.media.push({
                        filename: file.name,
                        type: file.type,
                        size: file.size,
                        data: base64,
                        captured_at: new Date().toISOString()
                    });

                    // Add preview
                    addPreview(base64, file.type, collectedData.media.length - 1);
                    filesAdded++;
                } catch (error) {
                    console.error('Error processing file:', error);
                    filesSkipped++;
                }
            }

            updateMediaCount();
            
            if (filesAdded > 0) {
                showStatus(`‚úÖ ${filesAdded} ${t.filesAdded}`, 'success');
            }
            if (filesSkipped > 0) {
                showStatus(`‚ö†Ô∏è ${filesSkipped} ${t.filesSkipped}`, 'error');
            }
            
            // Reset file inputs
            event.target.value = '';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function addPreview(base64, type, index) {
            const container = document.getElementById('previewContainer');
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.dataset.index = index;
            
            if (type.startsWith('image/')) {
                item.innerHTML = `
                    <img src="${base64}" alt="Preview">
                    <button class="remove-btn" onclick="removeMedia(${index})">√ó</button>
                `;
            } else if (type.startsWith('video/')) {
                item.innerHTML = `
                    <video src="${base64}"></video>
                    <button class="remove-btn" onclick="removeMedia(${index})">√ó</button>
                `;
            }
            
            container.appendChild(item);
        }

        function removeMedia(index) {
            collectedData.media.splice(index, 1);
            
            // Rebuild preview container
            const container = document.getElementById('previewContainer');
            container.innerHTML = '';
            
            collectedData.media.forEach((media, i) => {
                addPreview(media.data, media.type, i);
            });
            
            updateMediaCount();
            showStatus(t.fileRemoved, 'info');
        }

async function submitAll() {
    const submitBtn = document.querySelector('button[onclick="submitAll()"]');
    if (submitBtn) submitBtn.disabled = true; // Prevent double-clicks

    const formData = new FormData();
    
    // 1. Collect Metadata (Job info and User info)
    // We append these as individual fields so n8n sees them in the JSON body
    formData.append('job_id', document.getElementById('jobId')?.value || 'N/A');
    formData.append('timestamp', new Date().toISOString());
    
    if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
        const user = window.Telegram.WebApp.initDataUnsafe.user;
        formData.append('telegram_user_id', user.id);
        formData.append('telegram_username', user.username || '');
        formData.append('telegram_first_name', user.first_name || '');
    }

    // 2. Attach the actual files (images/videos)
    // 'allFiles' should be the array where your app stores the captured media objects
    if (typeof allFiles !== 'undefined' && allFiles.length > 0) {
        allFiles.forEach((fileObj, index) => {
            // fileObj.file is the actual Blob or File object from the input/camera
            formData.append('media', fileObj.file, fileObj.filename);
        });
    } else {
        alert("No media to upload!");
        if (submitBtn) submitBtn.disabled = false;
        return;
    }

    // 3. The Fetch Request
    try {
        const response = await fetch('https://n8n.la-renting.com/webhook/get-media', {
            method: 'POST',
            body: formData, // Browser automatically sets Content-Type to multipart/form-data
            mode: 'cors'
        });

        if (response.ok) {
            const result = await response.json();
            console.log('Upload Success:', result);
            alert('Job submitted successfully!');
            window.Telegram?.WebApp?.close();
        } else {
            const errorText = await response.text();
            console.error('Server Error:', errorText);
            alert(`Upload failed: ${response.status} - ${response.statusText}`);
        }
    } catch (error) {
        console.error('Fetch Error:', error);
        alert('Network error. Check your internet connection or server CORS settings.');
    } finally {
        if (submitBtn) submitBtn.disabled = false;
    }
}
    </script>
</body>
</html>


